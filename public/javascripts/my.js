// Generated by CoffeeScript 1.3.3
(function() {

  $(function() {
    var App, AppView, Todo, TodoList, TodoView, Todos;
    Todo = Backbone.Model.extend({
      idAttribute: "_id",
      defaults: function() {
        return {
          title: "empty todo...",
          done: false
        };
      },
      initialize: function() {
        if (!this.get("title")) {
          return this.set({
            "title": this.defaults().title
          });
        }
      },
      clear: function() {
        return this.destroy();
      }
    });
    TodoList = Backbone.Collection.extend({
      model: Todo,
      url: "/todos"
    });
    Todos = new TodoList;
    TodoView = Backbone.View.extend({
      tagName: "li",
      template: _.template($('#item-template').html()),
      events: {
        "click a.destroy": "clear",
        "dblclick .view": "edit",
        "keypress .edit": "updateOnEnter",
        "blur .edit": "close"
      },
      initialize: function() {
        this.model.bind('change', this.render, this);
        return this.model.bind('destroy', this.remove, this);
      },
      render: function() {
        this.$el.html(this.template(this.model.toJSON()));
        this.$el.toggleClass('done', this.model.get('done'));
        this.input = this.$('.edit');
        return this;
      },
      edit: function() {
        this.$el.addClass("editing");
        return this.input.focus();
      },
      updateOnEnter: function(e) {
        if (e.keyCode === 13) {
          return this.close();
        }
      },
      close: function() {
        var value;
        value = this.input.val();
        if (!value) {
          this.clear();
        }
        this.model.save({
          title: value
        });
        return this.$el.removeClass("editing");
      },
      clear: function() {
        return this.model.clear();
      }
    });
    AppView = Backbone.View.extend({
      el: $("#todoapp"),
      events: {
        "keypress #new-todo": "addTodo"
      },
      initialize: function() {
        this.input = this.$("#new-todo");
        Todos.bind("add", this.addOne, this);
        Todos.bind('reset', this.addAll, this);
        Todos.bind("all", this.render, this);
        this.footer = $('footer');
        this.main = $('#main');
        return Todos.fetch();
      },
      render: function() {
        this.main.show();
        this.footer.show();
        return $("#yama").html(Todos.length);
      },
      addOne: function(todo) {
        var view;
        view = new TodoView({
          model: todo
        });
        return this.$("#todo-list").append(view.render().el);
      },
      addTodo: function(e) {
        if (e.keyCode !== 13) {
          return;
        }
        Todos.create({
          title: this.input.val()
        });
        return this.input.val("");
      },
      addAll: function() {
        return Todos.each(this.addOne);
      }
    });
    return App = new AppView;
  });

}).call(this);
